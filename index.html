<script>
  async function enviarUbicacion() {
    const estado = document.getElementById("estado");
    const latSpan = document.getElementById("latitud");
    const lonSpan = document.getElementById("longitud");
    const dirSpan = document.getElementById("direccion");
    const mapaLink = document.getElementById("mapa");

    // Si ya se enviaron y hay datos guardados, los mostramos
    if (localStorage.getItem("ubicacionEnviada")) {
      latSpan.textContent = localStorage.getItem("lat");
      lonSpan.textContent = localStorage.getItem("lon");
      dirSpan.textContent = localStorage.getItem("direccion");
      mapaLink.href = localStorage.getItem("mapaURL");
      mapaLink.textContent = "üìç Ver en Google Maps";
      estado.textContent = "‚úÖ Ubicaci√≥n ya enviada.";
      return;
    }

    if (!navigator.geolocation) {
      estado.textContent = "‚ùå Geolocalizaci√≥n no disponible.";
      return;
    }

    estado.textContent = "üì° Obteniendo ubicaci√≥n...";

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      latSpan.textContent = lat;
      lonSpan.textContent = lon;

      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        const direccion = data.display_name || "Direcci√≥n no disponible";
        const mapaURL = `https://www.google.com/maps?q=${lat},${lon}`;

        dirSpan.textContent = direccion;
        mapaLink.href = mapaURL;
        mapaLink.textContent = "üìç Ver en Google Maps";

        // Guardar en localStorage
        localStorage.setItem("ubicacionEnviada", "true");
        localStorage.setItem("lat", lat);
        localStorage.setItem("lon", lon);
        localStorage.setItem("direccion", direccion);
        localStorage.setItem("mapaURL", mapaURL);

        // Enviar por FormSubmit
        document.getElementById("latitudInput").value = lat;
        document.getElementById("longitudInput").value = lon;
        document.getElementById("direccionInput").value = direccion;
        document.getElementById("mapaInput").value = mapaURL;

        estado.textContent = "‚úÖ Ubicaci√≥n enviada correctamente.";
        document.getElementById("formulario").submit();
      } catch (error) {
        estado.textContent = "‚ùå Error al obtener la direcci√≥n.";
      }
    }, () => {
      estado.textContent = "‚ùå No se pudo obtener la ubicaci√≥n.";
    });
  }

  function reiniciarEnvio() {
    localStorage.clear();
    location.reload();
  }

  window.onload = enviarUbicacion;
</script>
